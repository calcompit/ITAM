<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>noVNC - ES6 Module VNC Client</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        #vnc-canvas {
            width: 100vw !important;
            height: 100vh !important;
            display: block;
            cursor: crosshair;
            object-fit: contain;
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            pointer-events: auto;
        }

        /* Modern Status Bar */
        #status {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.85);
            padding: 12px 20px;
            border-radius: 12px;
            z-index: 1000;
            font-size: 14px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            min-width: 200px;
        }
        .status-connected { 
            color: #4ade80; 
            border-color: rgba(74, 222, 128, 0.3);
        }
        .status-connecting { 
            color: #fbbf24; 
            border-color: rgba(251, 191, 36, 0.3);
        }
        .status-error { 
            color: #f87171; 
            border-color: rgba(248, 113, 113, 0.3);
        }

        /* Modern VNC Toolbar */
        #vnc-toolbar {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.85);
            border-radius: 16px;
            padding: 20px;
            z-index: 1001;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            min-width: 280px;
            max-height: 80vh;
            overflow-y: auto;
            transition: all 0.3s ease;
        }
        #vnc-toolbar::-webkit-scrollbar {
            width: 6px;
        }
        #vnc-toolbar::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }
        #vnc-toolbar::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }

        .toolbar-section {
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 15px;
        }
        .toolbar-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .toolbar-title {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        .toolbar-button {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
            color: #fff;
            border: none;
            padding: 8px 16px;
            margin: 4px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .toolbar-button:hover {
            background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .toolbar-button.active {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .toolbar-button.danger {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
        }
        .toolbar-button.danger:hover {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
        }

        .toolbar-slider {
            width: 100%;
            margin: 8px 0;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.1);
            outline: none;
        }
        .toolbar-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .toolbar-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .toolbar-label {
            font-size: 12px;
            color: #cbd5e1;
            margin: 8px 0 4px 0;
            font-weight: 500;
        }
        .toolbar-value {
            font-size: 11px;
            color: #94a3b8;
            text-align: center;
            font-weight: 600;
        }
        .toolbar-toggle {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s ease;
        }
        .toolbar-toggle:hover {
            background: rgba(255,255,255,0.05);
        }
        .toolbar-toggle input[type="checkbox"] {
            margin-right: 10px;
            width: 16px;
            height: 16px;
            accent-color: #3b82f6;
        }
        .toolbar-toggle label {
            font-size: 12px;
            color: #cbd5e1;
            font-weight: 500;
        }

        /* Modern Toolbar Toggle */
        #toolbar-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px 16px;
            cursor: pointer;
            z-index: 1002;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            backdrop-filter: blur(20px);
        }
        #toolbar-toggle:hover {
            background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        .toolbar-hidden #vnc-toolbar {
            display: none;
        }

        /* Modern Connection Info */
        #connection-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.85);
            padding: 16px 20px;
            border-radius: 12px;
            z-index: 1000;
            font-size: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            max-width: 320px;
            transition: all 0.3s ease;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            padding: 4px 0;
        }
        .info-label {
            color: #94a3b8;
            font-weight: 500;
        }
        .info-value {
            color: #fff;
            font-weight: 600;
        }

        /* Multi-Monitor Controls */
        #monitor-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.85);
            border-radius: 12px;
            padding: 16px;
            z-index: 1000;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            min-width: 200px;
        }
        .monitor-button {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: #fff;
            border: none;
            padding: 8px 16px;
            margin: 4px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .monitor-button:hover {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            #vnc-toolbar {
                right: 10px;
                left: 10px;
                top: 10px;
                max-height: 70vh;
            }
            #status, #connection-info {
                left: 10px;
                right: 10px;
                max-width: none;
            }
            #monitor-controls {
                right: 10px;
                bottom: 10px;
            }
        }

        /* Animation for toolbar */
        .toolbar-enter {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Monitor Grid Layout */
        .monitor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
            height: 100vh;
        }
        .monitor-window {
            background: rgba(0,0,0,0.9);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
            position: relative;
        }
        .monitor-header {
            background: rgba(0,0,0,0.8);
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .monitor-title {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }
        .monitor-close {
            background: #dc2626;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="status" class="status-connecting">
        <span class="loading"></span> Connecting to VNC...
    </div>
    
    <div id="toolbar-toggle" onclick="toggleToolbar()">‚öôÔ∏è VNC Tools</div>
    
    <div id="vnc-toolbar" class="toolbar-enter">
        <!-- Display Controls -->
        <div class="toolbar-section">
            <div class="toolbar-title">üñ•Ô∏è Display</div>
            <button class="toolbar-button" onclick="fitToScreen()">üìê Fit Screen</button>
            <button class="toolbar-button" onclick="actualSize()">üîç 100%</button>
            <button class="toolbar-button" onclick="fullscreen()">‚õ∂ Fullscreen</button>
            <button class="toolbar-button" onclick="zoomIn()">üîç+ Zoom In</button>
            <button class="toolbar-button" onclick="zoomOut()">üîç- Zoom Out</button>
        </div>

        <!-- Quality Controls -->
        <div class="toolbar-section">
            <div class="toolbar-title">üé® Quality</div>
            <div class="toolbar-label">Quality Level</div>
            <input type="range" class="toolbar-slider" id="quality-slider" min="1" max="9" value="6" onchange="setQuality(this.value)">
            <div class="toolbar-value" id="quality-value">6</div>
            
            <div class="toolbar-label">Compression</div>
            <input type="range" class="toolbar-slider" id="compression-slider" min="0" max="9" value="2" onchange="setCompression(this.value)">
            <div class="toolbar-value" id="compression-value">2</div>
        </div>

        <!-- Connection Controls -->
        <div class="toolbar-section">
            <div class="toolbar-title">üîó Connection</div>
            <button class="toolbar-button" onclick="reconnect()">üîÑ Reconnect</button>
            <button class="toolbar-button danger" onclick="disconnect()">‚ùå Disconnect</button>
            <button class="toolbar-button" onclick="toggleViewOnly()" id="viewonly-btn">üëÅÔ∏è View Only</button>
        </div>

        <!-- Keyboard Controls -->
        <div class="toolbar-section">
            <div class="toolbar-title">‚å®Ô∏è Keyboard</div>
            <button class="toolbar-button" onclick="sendCtrlAltDel()">‚å®Ô∏è Ctrl+Alt+Del</button>
            <button class="toolbar-button" onclick="sendPrintScreen()">üì∏ Print Screen</button>
            <button class="toolbar-button" onclick="toggleKeyboard()" id="keyboard-btn">‚å®Ô∏è Keyboard</button>
        </div>

        <!-- Clipboard Controls -->
        <div class="toolbar-section">
            <div class="toolbar-title">üìã Clipboard</div>
            <button class="toolbar-button" onclick="copyFromRemote()">üìã Copy From</button>
            <button class="toolbar-button" onclick="pasteToRemote()">üìã Paste To</button>
            <button class="toolbar-button" onclick="clearClipboard()">üóëÔ∏è Clear</button>
        </div>

        <!-- Mouse Controls -->
        <div class="toolbar-section">
            <div class="toolbar-title">üñ±Ô∏è Mouse</div>
            <div class="toolbar-toggle">
                <input type="checkbox" id="mouse-toggle" checked onchange="toggleMouse(this.checked)">
                <label for="mouse-toggle">Enable Mouse</label>
            </div>
            <div class="toolbar-toggle">
                <input type="checkbox" id="cursor-toggle" checked onchange="toggleCursor(this.checked)">
                <label for="cursor-toggle">Show Cursor</label>
            </div>
            <div class="toolbar-toggle">
                <input type="checkbox" id="mouse-sync" checked onchange="toggleMouseSync(this.checked)">
                <label for="mouse-sync">Mouse Sync</label>
            </div>
        </div>

        <!-- Multi-Monitor Controls -->
        <div class="toolbar-section">
            <div class="toolbar-title">üñ•Ô∏è Multi-Monitor</div>
            <button class="toolbar-button" onclick="switchToMonitor(1)">üì∫ Monitor 1</button>
            <button class="toolbar-button" onclick="switchToMonitor(2)">üì∫ Monitor 2</button>
            <button class="toolbar-button" onclick="detectMonitors()">üîç Detect Monitors</button>
            <button class="toolbar-button" onclick="spanMonitors()">üîó Span Monitors</button>
        </div>
    </div>

    <!-- Multi-Monitor Controls -->
    <div id="monitor-controls">
        <div class="toolbar-title">üñ•Ô∏è Multi-Monitor</div>
        <button class="monitor-button" onclick="addMonitor()">‚ûï Add Monitor</button>
        <button class="monitor-button" onclick="splitScreen()">üìê Split Screen</button>
        <button class="monitor-button" onclick="toggleMonitorGrid()" id="grid-btn">üî≤ Grid View</button>
    </div>

    <div id="connection-info">
        <div class="info-row">
            <span class="info-label">Target:</span>
            <span class="info-value" id="target-info">-</span>
        </div>
        <div class="info-row">
            <span class="info-label">Status:</span>
            <span class="info-value" id="status-info">Connecting...</span>
        </div>
        <div class="info-row">
            <span class="info-label">Desktop:</span>
            <span class="info-value" id="desktop-info">-</span>
        </div>
        <div class="info-row">
            <span class="info-label">Resolution:</span>
            <span class="info-value" id="resolution-info">-</span>
        </div>
    </div>

    <canvas id="vnc-canvas"></canvas>

    <script type="module">
        // Import RFB from the ES6 module (default export)
        import RFB from './core/rfb.js';
        
        // Global RFB instance
        let rfb = null;
        let currentZoom = 1;
        let isViewOnly = false;
        let isKeyboardEnabled = true;
        let isMouseEnabled = true;
        let isCursorVisible = true;
        let isMouseSyncEnabled = true;
        let monitorCount = 0;
        let isGridMode = false;
        
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const host = urlParams.get('host') || '10.51.101.83';
        const port = urlParams.get('port') || '5900';
        const password = urlParams.get('password') || '123';

        // Update connection info
        document.getElementById('target-info').textContent = `${host}:${port}`;

        // Connect to websockify proxy
        const wsUrl = `ws://10.51.101.49:6081/websockify`;
        
        console.log('Connecting to websockify proxy:', wsUrl);
        console.log('Target VNC server:', `${host}:${port}`);
        console.log('Password:', password);
        
        // Create RFB connection
        rfb = new RFB(document.getElementById('vnc-canvas'), wsUrl, {
            credentials: { password: password },
            ignoreTLSWarnings: true,
            wsProtocols: ['binary'],
            repeaterID: '',
            shared: true,
            viewOnly: false,
            showDotCursor: true,
            background: '#000000',
            qualityLevel: 6,
            compressionLevel: 2,
            enableWebP: true,
            enableJPEG: true,
            enablePNG: true,
            enableResize: true,
            scaleViewport: true,
            resizeSession: true,
            clipViewport: false,
            scaleQuality: 'fast',
            mouse: true,
            keyboard: true,
            clipboard: true,
            audio: false,
            bell: false,
            allowTLSWarnings: true,
            suppressTLSWarnings: true,
            width: window.innerWidth,
            height: window.innerHeight
        });

        // Connection events
        rfb.addEventListener('connect', function() {
            console.log('VNC Connected successfully');
            document.getElementById('status').innerHTML = '‚úÖ Connected to VNC';
            document.getElementById('status').className = 'status-connected';
            document.getElementById('status-info').textContent = 'Connected';
            
            // Check and replace with RFB canvas after connection
            setTimeout(() => {
                checkRFBCanvas();
                // Auto fit to screen when connected
                setTimeout(fitToScreen, 500);
            }, 1000);
        });

        rfb.addEventListener('disconnect', function(e) {
            console.log('VNC Disconnected:', e.detail);
            document.getElementById('status').innerHTML = '‚ùå Disconnected: ' + (e.detail.clean ? 'Clean' : 'Error');
            document.getElementById('status').className = 'status-error';
            document.getElementById('status-info').textContent = 'Disconnected';
        });

        rfb.addEventListener('credentialsrequired', function() {
            console.log('Credentials required');
            document.getElementById('status').innerHTML = 'üîê Credentials required';
            document.getElementById('status').className = 'status-error';
            document.getElementById('status-info').textContent = 'Auth Required';
        });

        rfb.addEventListener('securityfailure', function(e) {
            console.log('Security failure:', e.detail);
            document.getElementById('status').innerHTML = 'üö´ Security failure: ' + e.detail.reason;
            document.getElementById('status').className = 'status-error';
            document.getElementById('status-info').textContent = 'Security Error';
        });

        rfb.addEventListener('error', function(e) {
            console.error('VNC Error:', e);
            document.getElementById('status').innerHTML = 'üí• Error: ' + e.detail.message;
            document.getElementById('status').className = 'status-error';
            document.getElementById('status-info').textContent = 'Error';
        });

        rfb.addEventListener('desktopname', function(e) {
            console.log('Desktop name:', e.detail.name);
            document.title = 'noVNC - ' + e.detail.name;
            document.getElementById('desktop-info').textContent = e.detail.name;
        });

        rfb.addEventListener('clipboard', function(e) {
            console.log('Clipboard event:', e.detail.text);
        });

        // Focus management
        document.getElementById('vnc-canvas').addEventListener('click', function() {
            rfb.focus();
        });

        // Debug canvas element
        const canvas = document.getElementById('vnc-canvas');
        console.log('Canvas element:', canvas);
        
        // Force canvas size
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        console.log('Canvas resized to:', canvas.width, 'x', canvas.height);
        
        // Handle window resize
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            console.log('Canvas resized on window resize:', canvas.width, 'x', canvas.height);
            updateResolutionInfo();
        });
        
        // Function to check RFB canvas after connection
        function checkRFBCanvas() {
            if (rfb && rfb._canvas) {
                console.log('RFB Canvas found:', rfb._canvas);
                console.log('RFB Canvas size:', rfb._canvas.width, 'x', rfb._canvas.height);
                
                // Replace our canvas with RFB's canvas
                const rfbCanvas = rfb._canvas;
                const container = canvas.parentNode;
                container.removeChild(canvas);
                container.appendChild(rfbCanvas);
                
                // Apply our styles to RFB canvas
                rfbCanvas.style.width = '100vw !important';
                rfbCanvas.style.height = '100vh !important';
                rfbCanvas.style.display = 'block';
                rfbCanvas.style.margin = '0 auto';
                rfbCanvas.style.background = '#000';
                rfbCanvas.style.cursor = 'crosshair';
                rfbCanvas.style.objectFit = 'contain';
                rfbCanvas.style.maxWidth = '100%';
                rfbCanvas.style.maxHeight = '100%';
                rfbCanvas.style.borderRadius = '8px';
                rfbCanvas.style.boxShadow = '0 8px 32px rgba(0,0,0,0.3)';
                rfbCanvas.style.pointerEvents = 'auto';
                
                // Fix mouse position sync
                rfbCanvas.addEventListener('mousemove', handleMouseMove);
                rfbCanvas.addEventListener('click', handleMouseClick);
                
                console.log('Replaced canvas with RFB canvas');
                updateResolutionInfo();
            }
        }

        function updateResolutionInfo() {
            if (rfb && rfb._canvas) {
                const width = rfb._canvas.width;
                const height = rfb._canvas.height;
                document.getElementById('resolution-info').textContent = `${width} x ${height}`;
            }
        }

        // Toolbar Functions
        window.toggleToolbar = function() {
            document.body.classList.toggle('toolbar-hidden');
            const toggle = document.getElementById('toolbar-toggle');
            toggle.textContent = document.body.classList.contains('toolbar-hidden') ? '‚öôÔ∏è VNC Tools' : '‚öôÔ∏è VNC Tools';
        };

        window.fitToScreen = function() {
            if (rfb && rfb._canvas) {
                rfb._canvas.style.objectFit = 'contain';
                rfb._canvas.style.width = '100vw';
                rfb._canvas.style.height = '100vh';
                currentZoom = 1;
                console.log('Fit to screen applied');
            }
        };

        window.actualSize = function() {
            if (rfb && rfb._canvas) {
                rfb._canvas.style.objectFit = 'none';
                rfb._canvas.style.width = rfb._canvas.naturalWidth + 'px';
                rfb._canvas.style.height = rfb._canvas.naturalHeight + 'px';
                currentZoom = 1;
                console.log('Actual size applied');
            }
        };

        window.fullscreen = function() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        };

        window.zoomIn = function() {
            if (rfb && rfb._canvas) {
                currentZoom *= 1.2;
                rfb._canvas.style.transform = `scale(${currentZoom})`;
                console.log('Zoom in:', currentZoom);
            }
        };

        window.zoomOut = function() {
            if (rfb && rfb._canvas) {
                currentZoom /= 1.2;
                rfb._canvas.style.transform = `scale(${currentZoom})`;
                console.log('Zoom out:', currentZoom);
            }
        };

        window.setQuality = function(level) {
            if (rfb) {
                rfb.qualityLevel = parseInt(level);
                document.getElementById('quality-value').textContent = level;
                console.log('Quality set to:', level);
            }
        };

        window.setCompression = function(level) {
            if (rfb) {
                rfb.compressionLevel = parseInt(level);
                document.getElementById('compression-value').textContent = level;
                console.log('Compression set to:', level);
            }
        };

        window.reconnect = function() {
            if (rfb) {
                rfb.disconnect();
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        };

        window.disconnect = function() {
            if (rfb) {
                rfb.disconnect();
            }
        };

        window.toggleViewOnly = function() {
            if (rfb) {
                isViewOnly = !isViewOnly;
                rfb.viewOnly = isViewOnly;
                const btn = document.getElementById('viewonly-btn');
                btn.textContent = isViewOnly ? 'üëÅÔ∏è View Only' : 'üñ±Ô∏è Interactive';
                btn.classList.toggle('active', isViewOnly);
                console.log('View only:', isViewOnly);
            }
        };

        window.sendCtrlAltDel = function() {
            if (rfb) {
                rfb.sendCtrlAltDel();
                console.log('Sent Ctrl+Alt+Del');
            }
        };

        window.sendPrintScreen = function() {
            if (rfb) {
                // Simulate Print Screen key
                const event = new KeyboardEvent('keydown', {
                    key: 'PrintScreen',
                    code: 'PrintScreen',
                    keyCode: 44,
                    which: 44,
                    bubbles: true
                });
                rfb._keyboard.handleKeyDown(event);
                console.log('Sent Print Screen');
            }
        };

        window.toggleKeyboard = function() {
            if (rfb) {
                isKeyboardEnabled = !isKeyboardEnabled;
                rfb.keyboard = isKeyboardEnabled;
                const btn = document.getElementById('keyboard-btn');
                btn.textContent = isKeyboardEnabled ? '‚å®Ô∏è Keyboard' : '‚å®Ô∏è Keyboard (Off)';
                btn.classList.toggle('active', !isKeyboardEnabled);
                console.log('Keyboard enabled:', isKeyboardEnabled);
            }
        };

        window.copyFromRemote = function() {
            if (rfb && rfb.clipboardText) {
                navigator.clipboard.writeText(rfb.clipboardText);
                console.log('Copied from remote:', rfb.clipboardText);
            }
        };

        window.pasteToRemote = function() {
            navigator.clipboard.readText().then(text => {
                if (rfb) {
                    rfb.clipboardText = text;
                    console.log('Pasted to remote:', text);
                }
            });
        };

        window.clearClipboard = function() {
            if (rfb) {
                rfb.clipboardText = '';
                console.log('Clipboard cleared');
            }
        };

        window.toggleMouse = function(enabled) {
            if (rfb) {
                isMouseEnabled = enabled;
                rfb.mouse = enabled;
                console.log('Mouse enabled:', enabled);
            }
        };

        window.toggleCursor = function(visible) {
            if (rfb && rfb._canvas) {
                isCursorVisible = visible;
                rfb._canvas.style.cursor = visible ? 'crosshair' : 'none';
                console.log('Cursor visible:', visible);
            }
        };

        // Mouse position handling
        function handleMouseMove(event) {
            if (!isMouseSyncEnabled) return;
            
            const canvas = event.target;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const x = (event.clientX - rect.left) * scaleX;
            const y = (event.clientY - rect.top) * scaleY;
            
            // Update mouse position for better sync
            if (rfb && rfb._mouse) {
                rfb._mouse._pos = { x: x, y: y };
            }
        }

        function handleMouseClick(event) {
            if (!isMouseSyncEnabled) return;
            
            const canvas = event.target;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const x = (event.clientX - rect.left) * scaleX;
            const y = (event.clientY - rect.top) * scaleY;
            
            console.log('Mouse click at:', x, y);
        }

        window.toggleMouseSync = function(enabled) {
            isMouseSyncEnabled = enabled;
            console.log('Mouse sync enabled:', enabled);
        };

        // Multi-Monitor Functions
        window.switchToMonitor = function(monitorNum) {
            console.log('Switching to monitor:', monitorNum);
            
            // Send key combination to switch monitor (Windows + P)
            if (rfb) {
                // Simulate Windows key + P
                const winKeyEvent = new KeyboardEvent('keydown', {
                    key: 'Meta',
                    code: 'MetaLeft',
                    keyCode: 91,
                    which: 91,
                    metaKey: true,
                    bubbles: true
                });
                
                const pKeyEvent = new KeyboardEvent('keydown', {
                    key: 'p',
                    code: 'KeyP',
                    keyCode: 80,
                    which: 80,
                    bubbles: true
                });
                
                // Send the key combination
                if (rfb._keyboard) {
                    rfb._keyboard.handleKeyDown(winKeyEvent);
                    setTimeout(() => {
                        rfb._keyboard.handleKeyDown(pKeyEvent);
                        setTimeout(() => {
                            // Send arrow key to select monitor
                            for (let i = 1; i < monitorNum; i++) {
                                const arrowEvent = new KeyboardEvent('keydown', {
                                    key: 'ArrowRight',
                                    code: 'ArrowRight',
                                    keyCode: 39,
                                    which: 39,
                                    bubbles: true
                                });
                                rfb._keyboard.handleKeyDown(arrowEvent);
                            }
                            // Press Enter to confirm
                            const enterEvent = new KeyboardEvent('keydown', {
                                key: 'Enter',
                                code: 'Enter',
                                keyCode: 13,
                                which: 13,
                                bubbles: true
                            });
                            rfb._keyboard.handleKeyDown(enterEvent);
                        }, 100);
                    }, 100);
                }
            }
        };

        window.detectMonitors = function() {
            console.log('Detecting monitors...');
            
            // Send Windows + P to show display options
            if (rfb && rfb._keyboard) {
                const winKeyEvent = new KeyboardEvent('keydown', {
                    key: 'Meta',
                    code: 'MetaLeft',
                    keyCode: 91,
                    which: 91,
                    metaKey: true,
                    bubbles: true
                });
                
                const pKeyEvent = new KeyboardEvent('keydown', {
                    key: 'p',
                    code: 'KeyP',
                    keyCode: 80,
                    which: 80,
                    bubbles: true
                });
                
                rfb._keyboard.handleKeyDown(winKeyEvent);
                setTimeout(() => {
                    rfb._keyboard.handleKeyDown(pKeyEvent);
                }, 100);
            }
        };

        window.spanMonitors = function() {
            console.log('Spanning across monitors...');
            
            // Send Windows + P and select extend mode
            if (rfb && rfb._keyboard) {
                const winKeyEvent = new KeyboardEvent('keydown', {
                    key: 'Meta',
                    code: 'MetaLeft',
                    keyCode: 91,
                    which: 91,
                    metaKey: true,
                    bubbles: true
                });
                
                const pKeyEvent = new KeyboardEvent('keydown', {
                    key: 'p',
                    code: 'KeyP',
                    keyCode: 80,
                    which: 80,
                    bubbles: true
                });
                
                rfb._keyboard.handleKeyDown(winKeyEvent);
                setTimeout(() => {
                    rfb._keyboard.handleKeyDown(pKeyEvent);
                    setTimeout(() => {
                        // Select "Extend" mode (usually the 3rd option)
                        const arrowEvent = new KeyboardEvent('keydown', {
                            key: 'ArrowRight',
                            code: 'ArrowRight',
                            keyCode: 39,
                            which: 39,
                            bubbles: true
                        });
                        rfb._keyboard.handleKeyDown(arrowEvent);
                        rfb._keyboard.handleKeyDown(arrowEvent);
                        
                        // Press Enter to confirm
                        const enterEvent = new KeyboardEvent('keydown', {
                            key: 'Enter',
                            code: 'Enter',
                            keyCode: 13,
                            which: 13,
                            bubbles: true
                        });
                        rfb._keyboard.handleKeyDown(enterEvent);
                    }, 100);
                }, 100);
            }
        };

        // Multi-Monitor Functions
        window.addMonitor = function() {
            monitorCount++;
            const monitorId = `monitor-${monitorCount}`;
            
            // Create new monitor window
            const monitorWindow = document.createElement('div');
            monitorWindow.className = 'monitor-window';
            monitorWindow.id = monitorId;
            monitorWindow.style.position = 'fixed';
            monitorWindow.style.top = '50px';
            monitorWindow.style.left = '50px';
            monitorWindow.style.width = '400px';
            monitorWindow.style.height = '300px';
            monitorWindow.style.zIndex = '999';
            
            monitorWindow.innerHTML = `
                <div class="monitor-header">
                    <div class="monitor-title">Monitor ${monitorCount}</div>
                    <button class="monitor-close" onclick="closeMonitor('${monitorId}')">‚úï</button>
                </div>
                <div style="padding: 10px; color: #fff;">
                    <p>New VNC connection to: ${host}:${port}</p>
                    <button class="toolbar-button" onclick="connectToMonitor('${monitorId}')">Connect</button>
                </div>
            `;
            
            document.body.appendChild(monitorWindow);
            console.log('Added monitor:', monitorId);
        };

        window.closeMonitor = function(monitorId) {
            const monitor = document.getElementById(monitorId);
            if (monitor) {
                monitor.remove();
                console.log('Closed monitor:', monitorId);
            }
        };

        window.connectToMonitor = function(monitorId) {
            // Create new VNC connection for this monitor
            const monitorUrl = `http://10.51.101.49:6081/vnc-module.html?host=${host}&port=${port}&password=${password}&monitor=${monitorId}`;
            window.open(monitorUrl, monitorId, 'width=800,height=600');
        };

        window.splitScreen = function() {
            // Create split screen layout
            const container = document.createElement('div');
            container.className = 'monitor-grid';
            container.style.position = 'fixed';
            container.style.top = '0';
            container.style.left = '0';
            container.style.width = '100vw';
            container.style.height = '100vh';
            container.style.zIndex = '998';
            container.style.background = '#1e3c72';
            
            // Create two monitor windows
            for (let i = 1; i <= 2; i++) {
                const monitorWindow = document.createElement('div');
                monitorWindow.className = 'monitor-window';
                monitorWindow.innerHTML = `
                    <div class="monitor-header">
                        <div class="monitor-title">Monitor ${i}</div>
                        <button class="monitor-close" onclick="closeSplitScreen()">‚úï</button>
                    </div>
                    <div style="padding: 10px; color: #fff;">
                        <p>Split screen monitor ${i}</p>
                        <button class="toolbar-button" onclick="connectSplitMonitor(${i})">Connect</button>
                    </div>
                `;
                container.appendChild(monitorWindow);
            }
            
            document.body.appendChild(container);
            console.log('Split screen created');
        };

        window.closeSplitScreen = function() {
            const grid = document.querySelector('.monitor-grid');
            if (grid) {
                grid.remove();
                console.log('Split screen closed');
            }
        };

        window.connectSplitMonitor = function(monitorNum) {
            const monitorUrl = `http://10.51.101.49:6081/vnc-module.html?host=${host}&port=${port}&password=${password}&monitor=${monitorNum}`;
            window.open(monitorUrl, `split-${monitorNum}`, 'width=800,height=600');
        };

        window.toggleMonitorGrid = function() {
            isGridMode = !isGridMode;
            const btn = document.getElementById('grid-btn');
            btn.textContent = isGridMode ? 'üî≤ Single View' : 'üî≤ Grid View';
            btn.classList.toggle('active', isGridMode);
            
            if (isGridMode) {
                // Create grid layout
                const container = document.createElement('div');
                container.className = 'monitor-grid';
                container.style.position = 'fixed';
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100vw';
                container.style.height = '100vh';
                container.style.zIndex = '998';
                container.style.background = '#1e3c72';
                
                // Create 4 monitor windows in grid
                for (let i = 1; i <= 4; i++) {
                    const monitorWindow = document.createElement('div');
                    monitorWindow.className = 'monitor-window';
                    monitorWindow.innerHTML = `
                        <div class="monitor-header">
                            <div class="monitor-title">Grid Monitor ${i}</div>
                            <button class="monitor-close" onclick="closeGrid()">‚úï</button>
                        </div>
                        <div style="padding: 10px; color: #fff;">
                            <p>Grid monitor ${i}</p>
                            <button class="toolbar-button" onclick="connectGridMonitor(${i})">Connect</button>
                        </div>
                    `;
                    container.appendChild(monitorWindow);
                }
                
                document.body.appendChild(container);
            } else {
                closeGrid();
            }
        };

        window.closeGrid = function() {
            const grid = document.querySelector('.monitor-grid');
            if (grid) {
                grid.remove();
                console.log('Grid closed');
            }
        };

        window.connectGridMonitor = function(monitorNum) {
            const monitorUrl = `http://10.51.101.49:6081/vnc-module.html?host=${host}&port=${port}&password=${password}&monitor=${monitorNum}`;
            window.open(monitorUrl, `grid-${monitorNum}`, 'width=800,height=600');
        };

        // Initialize toolbar state
        document.getElementById('quality-value').textContent = '6';
        document.getElementById('compression-value').textContent = '2';
    </script>
</body>
</html>
